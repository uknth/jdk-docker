language: generic
sudo: true

env:
    global:
          # ECR URL
        - ECR_URL="012629307706.dkr.ecr.us-east-1.amazonaws.com"
          # Tag Name
        - LATEST_TAG="latest"
services:
    - docker

before_install:
      # ---------------------------------------------------------------
      # BASE IMAGE
      # ---------------------------------------------------------------

      # Install Utils
      # ---------------------------------------------------------------
    - sudo apt-get install  --no-install-recommends tree curl python
    - sudo apt-get clean
    - sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
      
      # AWS Cli
    - sudo pip install awscli

      # Download Oracle - tar from the URL
      # ---------------------------------------------------------------
    - curl -v -j -k -L -H "Cookie:oraclelicense=accept-securebackup-cookie" https://download.oracle.com/otn-pub/java/jdk/8u201-b09/42970487e3af4f5aa5bca3f542482c60/jdk-8u201-linux-x64.tar.gz > ./base/oracle-jdk.tar.gz


      # ---------------------------------------------------------------
      # MAVEN IMAGE
      # ---------------------------------------------------------------
      # 
      # Clone Necessary Repository
    - git clone git@github.com:unbxd/asterix.git maven/projects/asterix
    - git clone git@github.com:unbxd/solr-plugin.git maven/projects/solr-plugin

      # Download Dependencies from S3
      # - aws s3 cp s3://unbxd-build-artifacts/solr/solr-plugins/solr-plugin-0.2.3.jar maven/projects/asterix/solr-plugin-latest.jar
      # Remove solr-plugin jar from maven base image.
    
install:
    - cd ./base && docker build -t oracle-jdk8-base:latest .
      # - cd ../maven && docker build -t oracle-jdk8-with-mvn:latest .
      # Remove maven-image build
      # TODO: Fix this later.

after_success:
    - eval $(aws ecr get-login --region us-east-1 --no-include-email)

    - docker tag oracle-jdk8-base:latest $ECR_URL/oracle-jdk8-base:$LATEST_TAG
    - docker push $ECR_URL/oracle-jdk8-base:$LATEST_TAG

      # - docker tag oracle-jdk8-with-mvn:latest $ECR_URL/oracle-jdk8-with-mvn:$LATEST_TAG
      # - docker push $ECR_URL/oracle-jdk8-with-mvn:$LATEST_TAG

notifications:
  slack: unbxd:60rvQrHi5prNg8dMCJBVAoZU

